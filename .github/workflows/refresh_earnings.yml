name: Refresh Earnings Calendar

on:
  schedule:
    - cron: '0 2 * * *'  # Runs daily at 02:00 UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  refresh-earnings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Call MarketData API to Refresh Earnings
        run: |
          # Call your Base44 function to sync earnings data
          curl -X POST "${{ secrets.BASE44_FUNCTION_URL }}/syncHybridEarnings" \
            -H "Authorization: Bearer ${{ secrets.BASE44_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}'
          
          echo "✅ Earnings calendar refreshed"
          
      - name: Fetch Updated Earnings Data
        run: |
          mkdir -p data/backups
          TIMESTAMP=$(date -u +"%Y-%m-%d")
          
          # Fetch updated earnings events
          curl -X GET "${{ secrets.BASE44_API_URL }}/entities/EarningsEvent" \
            -H "Authorization: Bearer ${{ secrets.BASE44_API_KEY }}" \
            -o "data/backups/earnings_refreshed_${TIMESTAMP}.json"
          
          echo "✅ Updated earnings data saved"
          
      - name: Commit Updated Data
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add data/backups/
          git commit -m "Earnings refresh: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push
