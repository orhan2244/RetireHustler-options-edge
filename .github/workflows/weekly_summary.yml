name: Weekly Trading Summary to Discord

on:
  schedule:
    # Every Friday 22:00 CET (21:00 UTC)
    - cron: '0 21 * * 5'
  workflow_dispatch: {}

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          WEEK_START=$(date -d "last monday" +"%Y-%m-%d")
          PRETTY_RANGE="$(date -d "$WEEK_START" '+%d %B') - $(date -d "$TODAY" '+%d %B')"
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "pretty_range=$PRETTY_RANGE" >> $GITHUB_OUTPUT

      - name: Fetch data from Base44
        run: |
          mkdir -p tmp

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=2000" \
            -o tmp/trades.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/RealizedLegProfit?limit=5000" \
            -o tmp/realized.json

      - name: Build weekly + cumulative metrics (includes constructed legs)
        id: build
        run: |
          set -euo pipefail

          WEEK_START='${{ steps.dates.outputs.week_start }}'
          TODAY='${{ steps.dates.outputs.today }}'
          PRETTY_RANGE='${{ steps.dates.outputs.pretty_range }}'
          USER_EMAIL="retirehustler@gmail.com"

          normalize () {
            FILE=$1
            if jq -e 'type=="array"' "$FILE" >/dev/null; then
              cat "$FILE"
            else
              jq -c '.items // []' "$FILE"
            fi
          }

          TRADES=$(normalize tmp/trades.json | jq --arg u "$USER_EMAIL" 'map(select(.created_by == $u))')
          REALIZED=$(normalize tmp/realized.json)

          ########################################
          # SIMPLE CLOSED TRADES (WEEK)
          # IMPORTANT: include Closed (Rolled) etc by startswith("CLOSED")
          ########################################
          SIMPLE_WEEK=$(echo "$TRADES" | jq \
            --arg s "$WEEK_START" \
            --arg e "$TODAY" '
            map(select(
              ((.status // "" | tostring | ascii_upcase) | startswith("CLOSED")) and
              ((.close_date // "" | tostring | split("T")[0]) >= $s) and
              ((.close_date // "" | tostring | split("T")[0]) <= $e)
            ))
          ')

          SIMPLE_WEEK_PL=$(echo "$SIMPLE_WEEK" | jq '[.[].profit_loss // 0] | add // 0')
          SIMPLE_WEEK_COUNT=$(echo "$SIMPLE_WEEK" | jq 'length')

          ########################################
          # CONSTRUCTED CLOSED LEGS (WEEK)
          # Filter by created_by if Base44 includes it, otherwise keep all
          ########################################
          CONSTRUCTED_WEEK=$(echo "$REALIZED" | jq \
            --arg s "$WEEK_START" \
            --arg e "$TODAY" \
            --arg u "$USER_EMAIL" '
            map(select(
              (.realization_date >= $s) and
              (.realization_date <= $e) and
              ((.created_by? // $u) == $u)
            ))
          ')

          CONSTRUCTED_WEEK_PL=$(echo "$CONSTRUCTED_WEEK" | jq '[.[].realized_pl // 0] | add // 0')
          CONSTRUCTED_WEEK_COUNT=$(echo "$CONSTRUCTED_WEEK" | jq 'length')

          ########################################
          # WEEK TOTALS
          ########################################
          WEEK_PL=$(jq -n --argjson a "$SIMPLE_WEEK_PL" --argjson b "$CONSTRUCTED_WEEK_PL" '
            ($a + $b)
          ')
          WEEK_COUNT=$((SIMPLE_WEEK_COUNT + CONSTRUCTED_WEEK_COUNT))

          ########################################
          # CUMULATIVE TOTALS (ALL TIME)
          ########################################
          TOTAL_SIMPLE=$(echo "$TRADES" | jq '
            map(select(((.status // "" | tostring | ascii_upcase) | startswith("CLOSED"))))
          ')
          TOTAL_SIMPLE_PL=$(echo "$TOTAL_SIMPLE" | jq '[.[].profit_loss // 0] | add // 0')
          TOTAL_SIMPLE_COUNT=$(echo "$TOTAL_SIMPLE" | jq 'length')

          TOTAL_CONSTRUCTED=$(echo "$REALIZED" | jq --arg u "$USER_EMAIL" '
            map(select((.created_by? // $u) == $u))
          ')
          TOTAL_CONSTRUCTED_PL=$(echo "$TOTAL_CONSTRUCTED" | jq '[.[].realized_pl // 0] | add // 0')
          TOTAL_CONSTRUCTED_COUNT=$(echo "$TOTAL_CONSTRUCTED" | jq 'length')

          TOTAL_PL=$(jq -n --argjson a "$TOTAL_SIMPLE_PL" --argjson b "$TOTAL_CONSTRUCTED_PL" '
            ($a + $b)
          ')
          TOTAL_COUNT=$((TOTAL_SIMPLE_COUNT + TOTAL_CONSTRUCTED_COUNT))

          ########################################
          # BEST / WORST of the week (across trades + legs)
          ########################################
          WEEK_ITEMS=$(jq -n \
            --argjson s "$SIMPLE_WEEK" \
            --argjson c "$CONSTRUCTED_WEEK" '
            ($s | map({ticker, pl:(.profit_loss // 0), kind:"Trade"})) +
            ($c | map({ticker, pl:(.realized_pl // 0), kind:"Leg"}))
          ')

          TOP_WIN=$(echo "$WEEK_ITEMS" | jq -r '
            if length>0 then
              max_by(.pl) | "\(.ticker) +\(.pl|tostring)"
            else
              "N/A"
            end
          ')

          TOP_LOSS=$(echo "$WEEK_ITEMS" | jq -r '
            if length>0 then
              min_by(.pl) | "\(.ticker) \(.pl|tostring)"
            else
              "N/A"
            end
          ')

          ########################################
          # FORMAT numbers (1 decimal like your old post)
          ########################################
          WEEK_PL_FMT=$(python3 - <<PY
          import os
          v=float(os.environ["WEEK_PL"])
          print(f"{v:.1f}")
          PY
          )
          TOTAL_PL_FMT=$(python3 - <<PY
          import os
          v=float(os.environ["TOTAL_PL"])
          print(f"{v:.1f}")
          PY
          )

          ########################################
          # BUILD SUMMARY (match your old style)
          ########################################
          if [ "$WEEK_COUNT" -eq 0 ]; then
            SUMMARY=$(printf "ðŸ“… %s\nðŸ“‰ Weekly P&L: \$0.0\nðŸ’¼ Number of Closed Trades: 0\nðŸ† Best Trade of the Week: N/A\nðŸ’° Cumulative P&L: \$%s\nðŸ“Š Cumulative Closed Trades: %s" \
              "$PRETTY_RANGE" "$TOTAL_PL_FMT" "$TOTAL_COUNT")
          else
            SUMMARY=$(printf "ðŸ“… %s\nðŸ“ˆ Weekly P&L: \$%s\nðŸ’¼ Number of Closed Trades: %s\nðŸ† Best Trade of the Week: %s\nðŸ“‰ Worst Trade of the Week: %s\nðŸ’° Cumulative P&L: \$%s\nðŸ“Š Cumulative Closed Trades: %s" \
              "$PRETTY_RANGE" "$WEEK_PL_FMT" "$WEEK_COUNT" "$TOP_WIN" "$TOP_LOSS" "$TOTAL_PL_FMT" "$TOTAL_COUNT")
          fi

          ESCAPED=$(printf "%s" "$SUMMARY" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          echo "summary=$ESCAPED" >> $GITHUB_OUTPUT

      - name: Send Weekly Summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.WEEKLY_DISCORD_WEBHOOK_URL }}
        run: |
          SUMMARY='${{ steps.build.outputs.summary }}'

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“Š Weekly Trading Recap",
              "color": 5814783,
              "fields": [
                { "name": "", "value": $SUMMARY }
              ],
              "footer": { "text": "RetireHustler Options Edge â€¢ Weekly â€¢ $(date +'%H:%M %Z')" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK" -o /dev/null -w "%{http_code}\n"
