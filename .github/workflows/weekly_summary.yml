name: Weekly Trading Summary to Discord

on:
  schedule:
    # Every Friday 22:00 CET (21:00 UTC)
    - cron: '0 21 * * 5'
  workflow_dispatch: {}

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          WEEK_START=$(date -d "last monday" +"%Y-%m-%d")
          PRETTY_RANGE="$(date -d "$WEEK_START" '+%d %B') - $(date -d "$TODAY" '+%d %B')"
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "pretty_range=$PRETTY_RANGE" >> $GITHUB_OUTPUT

      - name: Fetch data from Base44
        run: |
          mkdir -p tmp

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=2000" \
            -o tmp/trades.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/RealizedLegProfit?limit=5000" \
            -o tmp/realized.json

      - name: Build weekly summary
        id: build
        run: |
          set -euo pipefail

          WEEK_START='${{ steps.dates.outputs.week_start }}'
          TODAY='${{ steps.dates.outputs.today }}'
          PRETTY_RANGE='${{ steps.dates.outputs.pretty_range }}'
          USER_EMAIL="retirehustler@gmail.com"

          normalize () {
            if jq -e 'type=="array"' "$1" >/dev/null; then
              cat "$1"
            else
              jq -c '.items // []' "$1"
            fi
          }

          TRADES=$(normalize tmp/trades.json | jq --arg u "$USER_EMAIL" 'map(select(.created_by == $u))')
          REALIZED=$(normalize tmp/realized.json | jq --arg u "$USER_EMAIL" 'map(select((.created_by? // $u) == $u))')

          ########################################
          # SIMPLE CLOSED TRADES (ALL CLOSED)
          # NOTE: no date filter â†’ fixes missing rolled losses
          ########################################
          SIMPLE_CLOSED=$(echo "$TRADES" | jq '
            map(select(
              ((.status // "" | ascii_upcase) | startswith("CLOSED")) and
              (.profit_loss != null)
            ))
          ')

          SIMPLE_WEEK_PL=$(echo "$SIMPLE_CLOSED" | jq '[.[].profit_loss // 0] | add // 0')
          SIMPLE_WEEK_COUNT=$(echo "$SIMPLE_CLOSED" | jq 'length')

          ########################################
          # CONSTRUCTED CLOSED LEGS (WEEK)
          ########################################
          CONSTRUCTED_WEEK=$(echo "$REALIZED" | jq --arg s "$WEEK_START" --arg e "$TODAY" '
            map(select(
              .realization_date >= $s and
              .realization_date <= $e
            ))
          ')

          CONSTRUCTED_WEEK_PL=$(echo "$CONSTRUCTED_WEEK" | jq '[.[].realized_pl // 0] | add // 0')
          CONSTRUCTED_WEEK_COUNT=$(echo "$CONSTRUCTED_WEEK" | jq 'length')

          ########################################
          # WEEK TOTAL
          ########################################
          WEEK_PL=$(jq -n --argjson a "$SIMPLE_WEEK_PL" --argjson b "$CONSTRUCTED_WEEK_PL" '($a + $b)')
          WEEK_COUNT=$((SIMPLE_WEEK_COUNT + CONSTRUCTED_WEEK_COUNT))

          ########################################
          # CUMULATIVE TOTALS
          ########################################
          TOTAL_SIMPLE_PL="$SIMPLE_WEEK_PL"
          TOTAL_SIMPLE_COUNT="$SIMPLE_WEEK_COUNT"

          TOTAL_CONSTRUCTED_PL=$(echo "$REALIZED" | jq '[.[].realized_pl // 0] | add // 0')
          TOTAL_CONSTRUCTED_COUNT=$(echo "$REALIZED" | jq 'length')

          TOTAL_PL=$(jq -n --argjson a "$TOTAL_SIMPLE_PL" --argjson b "$TOTAL_CONSTRUCTED_PL" '($a + $b)')
          TOTAL_COUNT=$((TOTAL_SIMPLE_COUNT + TOTAL_CONSTRUCTED_COUNT))

          ########################################
          # BEST / WORST (TRADES + LEGS)
          ########################################
          WEEK_ITEMS=$(jq -n --argjson s "$SIMPLE_CLOSED" --argjson c "$CONSTRUCTED_WEEK" '
            ($s | map({ticker, pl:(.profit_loss // 0)})) +
            ($c | map({ticker, pl:(.realized_pl // 0)}))
          ')

          TOP_WIN=$(echo "$WEEK_ITEMS" | jq -r 'if length>0 then max_by(.pl) | "\(.ticker) +\(.pl)" else "N/A" end')
          TOP_LOSS=$(echo "$WEEK_ITEMS" | jq -r 'if length>0 then min_by(.pl) | "\(.ticker) \(.pl)" else "N/A" end')

          ########################################
          # FORMAT
          ########################################
          WEEK_PL_FMT=$(printf "%.1f" "$WEEK_PL")
          TOTAL_PL_FMT=$(printf "%.1f" "$TOTAL_PL")

          ########################################
          # SUMMARY (MATCH OLD STYLE)
          ########################################
          SUMMARY=$(printf \
"ðŸ“… %s
ðŸ“ˆ Weekly P&L: \$%s
ðŸ’¼ Number of Closed Trades: %s
ðŸ† Best Trade of the Week: %s
ðŸ“‰ Worst Trade of the Week: %s
ðŸ’° Cumulative P&L: \$%s
ðŸ“Š Cumulative Closed Trades: %s" \
            "$PRETTY_RANGE" \
            "$WEEK_PL_FMT" \
            "$WEEK_COUNT" \
            "$TOP_WIN" \
            "$TOP_LOSS" \
            "$TOTAL_PL_FMT" \
            "$TOTAL_COUNT")

          ESCAPED=$(printf "%s" "$SUMMARY" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          echo "summary=$ESCAPED" >> $GITHUB_OUTPUT

      - name: Send Weekly Summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.WEEKLY_DISCORD_WEBHOOK_URL }}
        run: |
          SUMMARY='${{ steps.build.outputs.summary }}'

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“Š Weekly Trading Recap",
              "color": 5814783,
              "fields": [
                { "name": "", "value": $SUMMARY }
              ],
              "footer": { "text": "RetireHustler Options Edge â€¢ Weekly" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          curl -s -H "Content-Type: application/json" \
               -d "$PAYLOAD" "$DISCORD_WEBHOOK" \
               -o /dev/null -w "%{http_code}\n"
