name: Weekly Trading Summary to Discord

on:
  schedule:
    # Every Friday 22:00 CET (21:00 UTC)
    - cron: '0 21 * * 5'
  workflow_dispatch: {}

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          WEEK_START=$(date -d "last monday" +"%Y-%m-%d")
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT

      - name: Fetch all trades from Base44
        id: fetch
        run: |
          mkdir -p tmp
          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/690f1138ddf92f0588990e04/entities/Trade" \
            -o tmp/trades.json

          # Validate JSON structure (array or object)
          if ! jq -e 'type=="array" or (type=="object" and has("items"))' tmp/trades.json > /dev/null; then
            echo "Invalid Base44 response:"
            cat tmp/trades.json
            exit 1
          fi

      - name: Build weekly and cumulative metrics
        id: build
        run: |
          set -euo pipefail
          WEEK_START='${{ steps.dates.outputs.week_start }}'
          TODAY='${{ steps.dates.outputs.today }}'

          # Detect array vs. object
          if jq -e 'type=="array"' tmp/trades.json >/dev/null; then
            ITEMS=$(cat tmp/trades.json)
          else
            ITEMS=$(jq -c '.items // []' tmp/trades.json)
          fi

          NORM=$(echo "$ITEMS" | jq '
            map({
              ticker,
              type,
              status: ((.status // "" | tostring) | ascii_upcase),
              close_date: ((.close_date // "" | tostring) | .[0:10]),
              profit_loss: (.profit_loss // 0)
            })
          ')

          WEEK_JSON=$(echo "$NORM" | jq --arg s "$WEEK_START" --arg e "$TODAY" '
            map(select(.status == "CLOSED" and .close_date >= $s and .close_date <= $e))
          ')
          WEEK_PL=$(echo "$WEEK_JSON" | jq '[.[].profit_loss] | add // 0')
          WEEK_COUNT=$(echo "$WEEK_JSON" | jq 'length')

          TOP_WIN=$(echo "$WEEK_JSON" | jq -r 'if length>0 then max_by(.profit_loss) | "\(.ticker) +\(.profit_loss)" else "N/A" end')
          TOP_LOSS=$(echo "$WEEK_JSON" | jq -r 'if length>0 then min_by(.profit_loss) | "\(.ticker) \(.profit_loss)" else "N/A" end')

          TOTAL_PL=$(echo "$NORM" | jq 'map(select(.status == "CLOSED")) | [.[].profit_loss] | add // 0')
          TOTAL_COUNT=$(echo "$NORM" | jq 'map(select(.status == "CLOSED")) | length')

          if [ "$WEEK_COUNT" -eq 0 ]; then
            SUMMARY="No closed trades this week ðŸ’¤"
          else
            SUMMARY="ðŸ“… Weekly: $WEEK_PL USD\nðŸ’¼ Trades closed: $WEEK_COUNT\nðŸ† Best: $TOP_WIN\nðŸ’€ Worst: $TOP_LOSS\n\nðŸ’° Cumulative P&L: $TOTAL_PL USD (Total $TOTAL_COUNT trades)"
          fi

          ESCAPED=$(printf "%s" "$SUMMARY" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          echo "summary=$ESCAPED" >> $GITHUB_OUTPUT
          echo "week_pl=$WEEK_PL" >> $GITHUB_OUTPUT
          echo "total_pl=$TOTAL_PL" >> $GITHUB_OUTPUT

      - name: Send Weekly Summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DAILY_DISCORD_WEBHOOK_URL }}
        run: |
          SUMMARY_RAW='${{ steps.build.outputs.summary }}'
          WEEK_PL=$(printf "%.2f" "${{ steps.build.outputs.week_pl }}")
          TOTAL_PL=$(printf "%.2f" "${{ steps.build.outputs.total_pl }}")

          SUMMARY=$(echo "$SUMMARY_RAW" | sed 's/\\n/\n/g')

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“† Weekly Trading Recap â€“ Week Ending $(date +%b\ %d, %Y)",
              "color": 5814783,
              "fields": [
                { "name": "ðŸ“ˆ Weekly P&L", "value": "**ðŸ’µ $WEEK_PL USD**", "inline": true },
                { "name": "ðŸ’° Cumulative P&L", "value": "**$TOTAL_PL USD**", "inline": true },
                { "name": "ðŸ§¾ Summary", "value": "$SUMMARY" }
              ],
              "footer": { "text": "RetireHustler Options Edge  â€¢  $(date +'%H:%M %Z')" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK" -o /dev/null
