name: Weekly Trading Summary to Discord

on:
  schedule:
    # Every Friday 22:00 CET (21:00 UTC)
    - cron: '0 21 * * 5'
  workflow_dispatch: {}

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          WEEK_START=$(date -d "last monday" +"%Y-%m-%d")
          echo "today=$TODAY" >> "$GITHUB_OUTPUT"
          echo "week_start=$WEEK_START" >> "$GITHUB_OUTPUT"

      - name: Fetch all trades from Base44
        id: fetch
        run: |
          set -euo pipefail
          mkdir -p tmp
          curl -sS "https://api.base44.io/api/trades" > tmp/trades.json
          # Expect a top-level JSON array with length >= 0
          jq -e 'type=="array"' tmp/trades.json >/dev/null

      - name: Build weekly and cumulative metrics
        id: build
        run: |
          set -euo pipefail
          WEEK_START='${{ steps.dates.outputs.week_start }}'
          TODAY='${{ steps.dates.outputs.today }}'

          # Normalize to the fields we need
          NORM=$(jq '
            map({
              ticker: (.ticker // "N/A"),
              type: (.type // ""),
              status: ((.status // "" | tostring) | ascii_upcase),
              close_date: ((.close_date // "" | tostring) | .[0:10]),
              profit_loss: (.profit_loss // 0)
            })
          ' tmp/trades.json)

          WEEK_JSON=$(echo "$NORM" | jq --arg s "$WEEK_START" --arg e "$TODAY" '
            map(select(.status=="CLOSED" and .close_date >= $s and .close_date <= $e))
          ')
          WEEK_PL=$(echo "$WEEK_JSON" | jq '[.[].profit_loss] | add // 0')
          WEEK_COUNT=$(echo "$WEEK_JSON" | jq 'length')
          TOP_WIN=$(echo "$WEEK_JSON" | jq -r 'select(length>0) | max_by(.profit_loss) | "\(.ticker) +\(.profit_loss)"' 2>/dev/null || echo "N/A")
          TOP_LOSS=$(echo "$WEEK_JSON" | jq -r 'select(length>0) | min_by(.profit_loss) | "\(.ticker) \(.profit_loss)"' 2>/dev/null || echo "N/A")

          ALL_JSON=$(echo "$NORM" | jq 'map(select(.status=="CLOSED"))')
          TOTAL_PL=$(echo "$ALL_JSON" | jq '[.[].profit_loss] | add // 0')
          TOTAL_COUNT=$(echo "$ALL_JSON" | jq 'length')

          if [ "$WEEK_COUNT" -eq 0 ]; then
            SUMMARY="No closed trades this week ðŸ’¤"
          else
            SUMMARY="ðŸ“… Weekly: $WEEK_PL USD\nðŸ’¼ Trades closed: $WEEK_COUNT\nðŸ† Best: $TOP_WIN\nðŸ’€ Worst: $TOP_LOSS\n\nðŸ’° Cumulative P&L: $TOTAL_PL USD (Total $TOTAL_COUNT trades)"
          fi

          # JSON-escape for embed field
          ESCAPED_SUMMARY=$(printf "%s" "$SUMMARY" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          echo "week_pl=$WEEK_PL" >> "$GITHUB_OUTPUT"
          echo "total_pl=$TOTAL_PL" >> "$GITHUB_OUTPUT"
          echo "summary=$ESCAPED_SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Send Weekly Summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DAILY_DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_WEBHOOK:-}" ]; then
            echo "Missing secret DAILY_DISCORD_WEBHOOK_URL"
            exit 1
          fi

          WEEK_PL='${{ steps.build.outputs.week_pl }}'
          TOTAL_PL='${{ steps.build.outputs.total_pl }}'
          SUMMARY_JSON='${{ steps.build.outputs.summary }}'
          TITLE="ðŸ“† Weekly Trading Recap â€“ Week Ending $(date +'%b %d, %Y')"

          # Build payload safely with jq to avoid quoting issues
          PAYLOAD=$(jq -n --arg title "$TITLE" \
                         --arg week  "$WEEK_PL" \
                         --arg total "$TOTAL_PL" \
                         --arg summary "$SUMMARY_JSON" '
            {
              embeds: [{
                title: $title,
                color: 15844367,
                fields: [
                  { name: "Weekly P&L",     value: ("`" + $week  + "`"),  inline: true },
                  { name: "Cumulative P&L", value: ("`" + $total + "`"),  inline: true },
                  { name: "Summary",        value: ($summary | fromjson) }
                ],
                timestamp: (now | todateiso8601),
                footer: { text: "RetireHustler Options Edge" }
              }]
            }')

          echo "Posting to Discordâ€¦"
          HTTP_CODE=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" "$DISCORD_WEBHOOK" || true)

          echo "HTTP_CODE=$HTTP_CODE"
          echo "Response body:"
          cat resp.json || true
          echo

          case "$HTTP_CODE" in
            2*) echo "Discord post OK";;
            *)  echo "Discord post FAILED with HTTP $HTTP_CODE"; exit 1;;
          esac
