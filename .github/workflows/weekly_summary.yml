name: Weekly Trading Summary to Discord

on:
  schedule:
    - cron: '0 21 * * 5'   # Friday 22:00 CET
  workflow_dispatch: {}

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get current date
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          WEEK_START=$(date -d "last monday" +"%Y-%m-%d")
          PRETTY_RANGE="$(date -d "$WEEK_START" '+%d %B') - $(date -d "$TODAY" '+%d %B')"
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "pretty_range=$PRETTY_RANGE" >> $GITHUB_OUTPUT

      - name: Fetch data from Base44
        run: |
          mkdir -p tmp

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=1000" \
            -o tmp/trades.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/RealizedLegProfit?limit=2000" \
            -o tmp/realized.json

      - name: Build weekly and cumulative metrics
        id: build
        run: |
          set -euo pipefail

          WEEK_START='${{ steps.dates.outputs.week_start }}'
          TODAY='${{ steps.dates.outputs.today }}'
          PRETTY_RANGE='${{ steps.dates.outputs.pretty_range }}'
          USER_EMAIL="retirehustler@gmail.com"

          normalize () {
            FILE=$1
            if jq -e 'type=="array"' "$FILE" >/dev/null; then
              cat "$FILE"
            else
              jq -c '.items // []' "$FILE"
            fi
          }

          TRADES=$(normalize tmp/trades.json | jq 'map(select(.created_by=="'"$USER_EMAIL"'"))')
          REALIZED=$(normalize tmp/realized.json)

          ########################################
          # SIMPLE CLOSED (WEEK)
          ########################################
          SIMPLE_WEEK=$(echo "$TRADES" | jq \
            --arg s "$WEEK_START" \
            --arg e "$TODAY" '
            map(select(
              (.status | ascii_upcase) == "CLOSED" and
              (.close_date | tostring | .[0:10]) >= $s and
              (.close_date | tostring | .[0:10]) <= $e
            ))
          ')

          SIMPLE_WEEK_PL=$(echo "$SIMPLE_WEEK" | jq '[.[].profit_loss // 0] | add // 0')
          SIMPLE_WEEK_COUNT=$(echo "$SIMPLE_WEEK" | jq 'length')

          ########################################
          # CONSTRUCTED CLOSED LEGS (WEEK)
          ########################################
          CONSTRUCTED_WEEK=$(echo "$REALIZED" | jq \
            --arg s "$WEEK_START" \
            --arg e "$TODAY" '
            map(select(
              .realization_date >= $s and
              .realization_date <= $e
            ))
          ')

          CONSTRUCTED_WEEK_PL=$(echo "$CONSTRUCTED_WEEK" | jq '[.[].realized_pl // 0] | add // 0')
          CONSTRUCTED_WEEK_COUNT=$(echo "$CONSTRUCTED_WEEK" | jq 'length')

          ########################################
          # TOTALS (ALL TIME)
          ########################################
          TOTAL_SIMPLE_PL=$(echo "$TRADES" | jq '
            map(select((.status | ascii_upcase)=="CLOSED"))
            | [.[].profit_loss // 0] | add // 0
          ')

          TOTAL_CONSTRUCTED_PL=$(echo "$REALIZED" | jq '
            [.[].realized_pl // 0] | add // 0
          ')

          TOTAL_PL=$(jq -n \
            --argjson a "$TOTAL_SIMPLE_PL" \
            --argjson b "$TOTAL_CONSTRUCTED_PL" \
            '($a + $b)')

          ########################################
          # SUMMARY
          ########################################
          WEEK_PL=$(jq -n \
            --argjson a "$SIMPLE_WEEK_PL" \
            --argjson b "$CONSTRUCTED_WEEK_PL" \
            '($a + $b) | (. * 100 | round) / 100')

          WEEK_COUNT=$((SIMPLE_WEEK_COUNT + CONSTRUCTED_WEEK_COUNT))

          TOTAL_PL_FMT=$(printf "%.1f" "$TOTAL_PL")
          WEEK_PL_FMT=$(printf "%.1f" "$WEEK_PL")

          if [ "$WEEK_COUNT" -eq 0 ]; then
            SUMMARY="No closed trades this week ðŸ’¤"
          else
            SUMMARY=$(printf \
          "ðŸ“… %s
          ðŸ“ˆ Weekly P&L: \$%s
          ðŸ’¼ Closed trades (incl. legs): %s
          ðŸ’° Cumulative P&L: \$%s" \
              "$PRETTY_RANGE" \
              "$WEEK_PL_FMT" \
              "$WEEK_COUNT" \
              "$TOTAL_PL_FMT")
          fi

          ESCAPED=$(printf "%s" "$SUMMARY" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          echo "summary=$ESCAPED" >> $GITHUB_OUTPUT

      - name: Send Weekly Summary to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.WEEKLY_DISCORD_WEBHOOK_URL }}
        run: |
          SUMMARY='${{ steps.build.outputs.summary }}'

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“Š Weekly Trading Recap",
              "color": 5814783,
              "fields": [
                { "name": "", "value": $SUMMARY }
              ],
              "footer": { "text": "RetireHustler Options Edge â€¢ Weekly" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )

          curl -s -H "Content-Type: application/json" \
               -d "$PAYLOAD" "$DISCORD_WEBHOOK" \
               -o /dev/null -w "%{http_code}\n"
