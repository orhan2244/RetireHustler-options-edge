name: Daily CET Trading Summary to Discord

on:
  schedule:
    - cron: '5 21 * * 1-5'   # Runs 22:00 CET / 21:00 UTC all year
  workflow_dispatch: {}

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get today's date (CET/CEST)
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          PRETTY=$(date +"%b %d, %Y")
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "pretty=$PRETTY" >> $GITHUB_OUTPUT

      - name: Fetch all trades from Base44
        id: fetch
        run: |
          mkdir -p tmp

          # FIX 1 â€” Use correct Base44 header
          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=1000" \
            -o tmp/trades.json

          if ! jq -e 'type=="array" or (type=="object" and has("items"))' tmp/trades.json > /dev/null; then
            echo "âŒ Invalid Base44 response:"
            cat tmp/trades.json
            exit 1
          fi

      - name: Build daily metrics & lists
        id: build
        run: |
          TODAY=$(date -d "yesterday" +"%Y-%m-%d")

          USER_EMAIL="retirehustler@gmail.com"

          # Normalize trade list (array or items[])
          if jq -e 'type=="array"' tmp/trades.json >/dev/null; then
            ITEMS=$(cat tmp/trades.json)
          else
            ITEMS=$(jq -c '.items // []' tmp/trades.json)
          fi

          # FIX 2 â€” Filter ONLY your trades
          ITEMS=$(echo "$ITEMS" | jq 'map(select(.created_by == "'"$USER_EMAIL"'"))')

          ########################################
          # CLOSED trades today
          ########################################
          CLOSED_JSON=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.close_date|tostring) | startswith($d)))
          ')

          CLOSED_LINES=$(echo "$CLOSED_JSON" | jq -r '
          .[] |

          # prefix rules
          .prefix =
          (if .direction=="BUY" and .status=="Closed" then "Sell to Close"
             elif .direction=="SELL" and .status=="Closed" then "Buy to Close"
             else "" end) |

            # qty (integer formatting)
            .qty = (if .quantity!=null then (.quantity|floor) else .quantity end) |
      
            # strikes (exactly as stored, no .0 added)
            .s1 = (.strike_price // "") |
            .s2 = (.strike_price_2 // "") |

            # close price (use close_price or close_value)
            .px = (.close_price // .close_value // .close_premium // "") |

            # profit rounded to 2 decimals
          .pl = (if .profit_loss!=null then ((.profit_loss*100)|round/100) else 0 end) |
    
            # ROI already correct, but convert numeric â†’ string cleanly
            .roi = (if .return_on_capital!=null
          then ((.return_on_capital*100*100)|round/100)
          elif (.buying_power!=null and .buying_power!=0)
          then (((.profit_loss/.buying_power)*100*100)|round/100)
          else 0 end) |

            # ðŸ”¥ only if profit > 0
            .flame = (if .profit_loss!=null and .profit_loss > 0 then " ðŸ”¥" else "" end) |

            "\( .prefix ) \( .qty ) \( .ticker ) - \( .type ) - \( .s1 )/\( .s2 ) @ \( .px ) for $\(.pl) profit with \(.roi)% ROI\( .flame )"
          ')

          ########################################
          # OPENED trades today
          ########################################
          OPEN_JSON=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.open_date|tostring) | startswith($d)))
          ')

          OPEN_LINES=$(echo "$OPEN_JSON" | jq -r '
          .[] |

          # prefix rules
          .prefix =
            (if .direction=="BUY" and .status=="Open" then "Buy to Open"
             elif .direction=="SELL" and .status=="Open" then "Sell to Open"
             else "" end) |

            # qty integer
            .qty = (if .quantity!=null then (.quantity|floor) else .quantity end) |

          # strikes exactly as-is
            .s1 = (.strike_price // "") |
            .s2 = (.strike_price_2 // "") |

          # open price
            .px = (.open_price // .open_value // .open_premium // "") |

            "\( .prefix ) \( .qty ) \( .ticker ) - \( .type ) - \( .s1 )/\( .s2 ) @\( .px ) Exp \( .expiration_date )"
            ')
          ########################################
          # Daily closed P&L
          ########################################
          DAILY_PL=$(echo "$CLOSED_JSON" | jq '[.[].profit_loss // 0] | add // 0')

          # Fallbacks
          if [ -z "$CLOSED_LINES" ]; then CLOSED_LINES="(no closed trades today)"; fi
          if [ -z "$OPEN_LINES" ]; then OPEN_LINES="(no opened trades today)"; fi

          CLOSED_ESCAPED=$(printf "%s" "$CLOSED_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          OPEN_ESCAPED=$(printf "%s" "$OPEN_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          echo "daily_pl=$DAILY_PL" >> $GITHUB_OUTPUT
          echo "closed_list=$CLOSED_ESCAPED" >> $GITHUB_OUTPUT
          echo "open_list=$OPEN_ESCAPED" >> $GITHUB_OUTPUT

      - name: Send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DAILY_DISCORD_WEBHOOK_URL }}
        run: |
          PRETTY='${{ steps.dates.outputs.pretty }}'
          PL='${{ steps.build.outputs.daily_pl }}'
          CLOSED='${{ steps.build.outputs.closed_list }}'
          OPEN='${{ steps.build.outputs.open_list }}'

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“Š Daily Trading Summary â€“ $PRETTY ",
              "color": 3447003,
              "fields": [
                { "name": "ðŸ’° Daily Closed P&L", "value": "\`$PL\`", "inline": true },
                { "name": "âœ… Closed Today", "value": $CLOSED },
                { "name": "ðŸ“‚ Opened Today", "value": $OPEN }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
              "footer": { "text": "RetireHustler Options Edge" }
            }]
          }
          EOF
          )

          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK" -o /dev/null -w "%{http_code}\n"
