name: Daily CET Trading Summary to Discord

on:
  schedule:
    - cron: '5 21 * * 1-5'
  workflow_dispatch: {}

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get today's date (CET/CEST)
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          PRETTY=$(date +"%b %d, %Y")
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "pretty=$PRETTY" >> $GITHUB_OUTPUT

      - name: Fetch data from Base44
        run: |
          mkdir -p tmp

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=1000" \
            -o tmp/trades.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/MasterTrade?limit=1000" \
            -o tmp/master.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/TradeLeg?limit=2000" \
            -o tmp/legs.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/RealizedLegProfit?limit=2000" \
            -o tmp/realized.json

      - name: Build daily metrics & lists
        id: build
        run: |
          TODAY='${{ steps.dates.outputs.today }}'
          USER_EMAIL="retirehustler@gmail.com"

          if jq -e 'type=="array"' tmp/trades.json >/dev/null; then
          ITEMS=$(cat tmp/trades.json)
          else
          ITEMS=$(jq -c '.items // []' tmp/trades.json)
          fi

          ITEMS=$(echo "$ITEMS" | jq 'map(select(.created_by == "'"$USER_EMAIL"'"))')

          ########################################
          # SIMPLE CLOSED TRADES
          ########################################
          CLOSED_JSON=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.close_date|tostring) | startswith($d)))
          ')

          CLOSED_SIMPLE_LINES=$(echo "$CLOSED_JSON" | jq -r '
            .[]
            | .prefix =
              (if .direction=="BUY" then "Sell to Close"
               elif .direction=="SELL" then "Buy to Close"
               else "" end)
            | .qty = (.quantity|tostring|sub("\\.0$";""))
            | .s1 = (.strike_price|tostring|sub("\\.0$";""))
            | .s2 = (.strike_price_2|tostring|sub("\\.0$";""))
            | .price = (.close_price // "N/A")
            | .pl = (.profit_loss|tostring)
            | "\(.prefix) \(.qty) \(.ticker) â€“ \(.type) â€“ \(.s1)/\(.s2) @ \(.price) â†’ $\(.pl)"
          ')

          ########################################
          # CONSTRUCTED CLOSED LEGS (AUTHORITATIVE)
          ########################################
          if jq -e 'type=="array"' tmp/realized.json >/dev/null; then
          REALIZED=$(cat tmp/realized.json)
          else
          REALIZED=$(jq -c '.items // []' tmp/realized.json)
          fi
          
          if jq -e 'type=="array"' tmp/legs.json >/dev/null; then
          LEGS=$(cat tmp/legs.json)
          else
          LEGS=$(jq -c '.items // []' tmp/legs.json)
          fi
          
          if jq -e 'type=="array"' tmp/master.json >/dev/null; then
          MASTER=$(cat tmp/master.json)
          else
          MASTER=$(jq -c '.items // []' tmp/master.json)
          fi

          TODAY_REALIZED=$(echo "$REALIZED" | jq --arg d "$TODAY" '
            map(select(.realization_date == $d))
          ')

          CLOSED_CONSTRUCTED_LINES=$(echo "$TODAY_REALIZED" | jq -r \
            --argjson legs "$LEGS" \
            --argjson master "$MASTER" '
            .[]
            | . as $r
            | ($legs | map(select(.id == $r.trade_leg_id)) | .[0]) as $leg
            | ($master | map(select(.id == $r.master_trade_id)) | .[0]) as $m
            | .action =
                (if $leg.direction=="SELL"
                 then "Buy to Close"
                 else "Sell to Close" end)
            | "\($r.ticker) â€“ \($m.strategy)\n\(.action) \($leg.type) \($leg.strike_price) â†’ $" + ($r.realized_pl|tostring)
          ')

          ########################################
          # MERGE CLOSED
          ########################################
          CLOSED_LINES=$(printf "%s\n%s" "$CLOSED_SIMPLE_LINES" "$CLOSED_CONSTRUCTED_LINES")

          ########################################
          # OPENED SIMPLE TRADES
          ########################################
          OPEN_JSON=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.open_date|tostring) | startswith($d)))
          ')

          OPEN_LINES=$(echo "$OPEN_JSON" | jq -r '
            .[]
            | .prefix =
              (if .direction=="BUY" then "Buy to Open"
               elif .direction=="SELL" then "Sell to Open"
               else "" end)
            | "\(.prefix) \(.quantity) \(.ticker) â€“ \(.type) â€“ \(.strike_price) Exp \(.expiration_date)"
          ')

          ########################################
          # DAILY P/L
          ########################################
          PL_SIMPLE=$(echo "$CLOSED_JSON" | jq '[.[].profit_loss // 0] | add // 0')
          PL_CONSTRUCTED=$(echo "$TODAY_REALIZED" | jq '[.[].realized_pl // 0] | add // 0')

          DAILY_PL=$(jq -n '
          ($PL_SIMPLE + $PL_CONSTRUCTED)
          | (. * 100 | round) / 100
          | "$" + tostring
          ' --argjson PL_SIMPLE "$PL_SIMPLE" --argjson PL_CONSTRUCTED "$PL_CONSTRUCTED")

          ########################################
          # FALLBACKS + OUTPUT
          ########################################
          [ -z "$CLOSED_LINES" ] && CLOSED_LINES="(no closed trades today)"
          [ -z "$OPEN_LINES" ] && OPEN_LINES="(no opened trades today)"

          echo "daily_pl=$DAILY_PL" >> $GITHUB_OUTPUT
          echo "closed_list=$(printf "%s" "$CLOSED_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')" >> $GITHUB_OUTPUT
          echo "open_list=$(printf "%s" "$OPEN_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')" >> $GITHUB_OUTPUT

      - name: Send Discord message (DEBUG)
        env:
          DISCORD_WEBHOOK: ${{ secrets.DAILY_DISCORD_WEBHOOK_URL }}
        run: |
          echo "Webhook is: ${DISCORD_WEBHOOK:0:30}..."

          PRETTY='${{ steps.dates.outputs.pretty }}'
          PL='${{ steps.build.outputs.daily_pl }}'
          CLOSED='${{ steps.build.outputs.closed_list }}'
          OPEN='${{ steps.build.outputs.open_list }}'

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“Š Daily Trading Summary â€“ $PRETTY",
              "color": 3447003,
              "fields": [
                { "name": "ðŸ’° Daily Closed P&L", "value": "**$PL**", "inline": false },
                { "name": "âœ… Closed Today", "value": $CLOSED },
                { "name": "ðŸ“‚ Opened Today", "value": $OPEN }
              ]
            }]
          }
          EOF
          )

          echo "---- PAYLOAD ----"
          echo "$PAYLOAD"
          echo "-----------------"

          HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK")

          echo "HTTP CODE: $HTTP_CODE"
          echo "RESPONSE:"
          cat response.txt
