name: Daily CET Trading Summary to Discord

on:
  schedule:
    - cron: '5 21 * * 1-5'
  workflow_dispatch: {}

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Prague

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get today's date (CET/CEST)
        id: dates
        run: |
          TODAY=$(date +"%Y-%m-%d")
          PRETTY=$(date +"%b %d, %Y")
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "pretty=$PRETTY" >> $GITHUB_OUTPUT

      - name: Fetch data from Base44
        run: |
          mkdir -p tmp

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/Trade?limit=1000" \
            -o tmp/trades.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/MasterTrade?limit=1000" \
            -o tmp/master.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/TradeLeg?limit=2000" \
            -o tmp/legs.json

          curl -s -H "api_key: ${{ secrets.BASE44_API_KEY }}" \
            "https://app.base44.com/api/apps/6921d8e3ab33f86e081375a1/entities/RealizedLegProfit?limit=2000" \
            -o tmp/realized.json

      - name: Build daily metrics & lists
        id: build
        run: |
          TODAY='${{ steps.dates.outputs.today }}'
          USER_EMAIL="retirehustler@gmail.com"

          normalize () {
            FILE=$1
            if jq -e 'type=="array"' "$FILE" >/dev/null; then
              cat "$FILE"
            else
              jq -c '.items // []' "$FILE"
            fi
          }

          ITEMS=$(normalize tmp/trades.json | jq 'map(select(.created_by == "'"$USER_EMAIL"'"))')
          MASTER=$(normalize tmp/master.json)
          LEGS=$(normalize tmp/legs.json)
          REALIZED=$(normalize tmp/realized.json)

          ########################################
          # SIMPLE CLOSED TRADES (UNCHANGED)
          ########################################
          CLOSED_JSON=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.close_date | tostring | split("T")[0]) == $d))
          ')

          CLOSED_SIMPLE_LINES=$(echo "$CLOSED_JSON" | jq -r '
            .[]
            | (if .direction=="BUY" then "Sell to Close" else "Buy to Close" end)
              + " " + (.quantity|tostring)
              + " " + .ticker
              + " â€“ " + .type
              + " " + (.strike_price|tostring)
              + " â†’ $" + (.profit_loss|tostring)
          ')

          ########################################
          # CONSTRUCTED CLOSED LEGS (UPDATED)
          ########################################
          TODAY_REALIZED=$(echo "$REALIZED" | jq --arg d "$TODAY" '
            map(select(.realization_date == $d))
          ')

          CLOSED_CONSTRUCTED_LINES=$(echo "$TODAY_REALIZED" | jq -r \
            --argjson legs "$LEGS" '
            .[]
            | . as $r
            | ($legs | map(select(.id == $r.trade_leg_id)) | .[0]) as $leg
            | (if $leg.direction=="SELL" then "Buy to Close" else "Sell to Close" end) as $action
            | ($leg.type | if .=="Call" then "C" else "P" end) as $cp
            | "\($action) \($leg.strike_price) \($cp) for $\($r.realized_pl) profit"
          ')

          CLOSED_LINES=$(printf "%s\n%s" "$CLOSED_SIMPLE_LINES" "$CLOSED_CONSTRUCTED_LINES" | sed '/^[[:space:]]*$/d')
          [ -z "$CLOSED_LINES" ] && CLOSED_LINES="(no closed trades today)"

          ########################################
          # SIMPLE OPEN TRADES (UNCHANGED)
          ########################################
          OPEN_SIMPLE_LINES=$(echo "$ITEMS" | jq --arg d "$TODAY" '
            map(select((.open_date | tostring | split("T")[0]) == $d))
            | .[]
            | (if .direction=="BUY" then "Buy to Open" else "Sell to Open" end)
              + " " + (.quantity|tostring)
              + " " + .ticker
              + " â€“ " + .type
              + " " + (.strike_price|tostring)
              + " Exp " + .expiration_date
          ')

          ########################################
          # CONSTRUCTED OPEN TRADES (UPDATED)
          ########################################
          OPEN_CONSTRUCTED_LINES=$(echo "$MASTER" | jq --arg d "$TODAY" \
            --argjson legs "$LEGS" '
            map(select((.open_date | tostring | split("T")[0]) == $d))
            | .[]
            | . as $m
            | ($legs | map(select(.master_id == $m.id))) as $legs_for_master
            | ($legs_for_master
                | map(
                    (if .direction=="BUY" then "Buy " else "Sell " end)
                    + (.strike_price|tostring)
                    + " "
                    + (if .type=="Call" then "C" else "P" end)
                  )
                | join(" / ")
              ) as $legs_txt
            | ($legs_for_master | map(.expiration_date) | unique) as $exps
            | ($exps | if length==1 then .[0] else join(" / ") end) as $exp_txt
            | "Open " + $m.ticker + " â€“ " + $m.strategy + " â€“ " + $legs_txt + " â€“ Exp " + $exp_txt
          ')

          OPEN_LINES=$(printf "%s\n%s" "$OPEN_SIMPLE_LINES" "$OPEN_CONSTRUCTED_LINES" | sed '/^[[:space:]]*$/d')
          [ -z "$OPEN_LINES" ] && OPEN_LINES="(no opened trades today)"

          ########################################
          # DAILY P/L
          ########################################
          PL_SIMPLE=$(echo "$CLOSED_JSON" | jq '[.[].profit_loss // 0] | add // 0')
          PL_CONSTRUCTED=$(echo "$TODAY_REALIZED" | jq '[.[].realized_pl // 0] | add // 0')

          DAILY_PL=$(jq -n '
            ($a + $b) | (. * 100 | round) / 100 | "$" + tostring
          ' --argjson a "$PL_SIMPLE" --argjson b "$PL_CONSTRUCTED")

          echo "daily_pl=$DAILY_PL" >> $GITHUB_OUTPUT
          echo "closed_list=$(printf "%s" "$CLOSED_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')" >> $GITHUB_OUTPUT
          echo "open_list=$(printf "%s" "$OPEN_LINES" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')" >> $GITHUB_OUTPUT

      - name: Send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DAILY_DISCORD_WEBHOOK_URL }}
          PRETTY: ${{ steps.dates.outputs.pretty }}
          DAILY_PL: ${{ steps.build.outputs.daily_pl }}
          CLOSED_JSON: ${{ steps.build.outputs.closed_list }}
          OPEN_JSON: ${{ steps.build.outputs.open_list }}
        run: |
          python3 <<'PY'
          import json, os, subprocess

          payload = {
            "embeds": [{
              "title": f"ðŸ“Š Daily Trading Summary â€“ {os.environ['PRETTY']}",
              "color": 3447003,
              "fields": [
                { "name": "ðŸ’° Daily Closed P&L", "value": f"**{os.environ['DAILY_PL']}**", "inline": False },
                { "name": "âœ… Closed Today", "value": json.loads(os.environ["CLOSED_JSON"]), "inline": False },
                { "name": "ðŸ“‚ Opened Today", "value": json.loads(os.environ["OPEN_JSON"]), "inline": False }
              ],
              "footer": { "text": "RetireHustler Options Edge" }
            }]
          }

          subprocess.run(
            ["curl", "-s", "-H", "Content-Type: application/json",
             "-d", json.dumps(payload), os.environ["DISCORD_WEBHOOK"]],
            check=True
          )
          PY
